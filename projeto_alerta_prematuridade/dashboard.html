<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>SAP Dashboard - Sistema de Alerta Prematuro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {margin:0;padding:0;box-sizing:border-box;}
    body {font-family:Arial,sans-serif;background:#667eea;color:#333;}
    .container {max-width:1200px;margin:0 auto;padding:20px;}
    .header {text-align:center;color:white;margin-bottom:20px;}
    .header h1 {font-size:2.5em;}
    .status-online {display:inline-block;width:10px;height:10px;border-radius:50%;background:#2ecc71;animation:pulse 2s infinite;margin-right:5px;}
    @keyframes pulse {0%{opacity:1}50%{opacity:0.5}100%{opacity:1}}
    .stats-grid {display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-bottom:20px;}
    .stat-card {background:rgba(255,255,255,0.2);padding:15px;border-radius:8px;text-align:center;color:white;}
    .stat-number {font-size:2em;font-weight:bold;color:#ffd700;}
    select {padding:5px;margin:10px;}
    canvas {background:white;border-radius:8px;display:block;margin:20px auto;}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <span class="status-online"></span>
      <h1>ðŸš€ SAP Dashboard</h1>
      <p>Sistema de Alerta Prematuro â€“ Monitoramento em Tempo Real</p>
    </div>

    <div class="stats-grid">
      <div class="stat-card"><div class="stat-number" id="total-geral">0</div>Total Geral</div>
      <div class="stat-card"><div class="stat-number" id="total-mes">0</div>Total MÃªs</div>
      <div class="stat-card"><div class="stat-number" id="total-ano">0</div>Total Ano</div>
      <div class="stat-card"><div class="stat-number" id="total-7dias">0</div>Ãšltimos 7 dias</div>
      <div class="stat-card"><div class="stat-number" id="total-24h">0</div>Ãšltimas 24h</div>
    </div>

    <div style="text-align:center;margin-bottom:20px;">
      <label>PerÃ­odo:
        <select id="periodo" onchange="atualizarDashboard()">
          <option value="geral">Geral</option>
          <option value="mes">MÃªs</option>
          <option value="ano">Ano</option>
          <option value="7dias">7 dias</option>
          <option value="24h">24h</option>
        </select>
      </label>
    </div>

    <canvas id="timelineChart" width="600" height="200"></canvas>

    <div style="margin-top:20px;color:white;text-align:center;">
      <h3>ðŸŒŸ ONG Prematuridade.com</h3>
      <p>Parceiro EstratÃ©gico â€“ Maior Rede de Apoio a Prematuros do Brasil</p>
      <p><strong>FamÃ­lias/mÃªs:</strong> 600 â€¢ <strong>Estados:</strong> 23 â€¢ <strong>Anos:</strong> 15 â€¢ <strong>SatisfaÃ§Ã£o:</strong> 97%</p>
    </div>
    <div style="text-align:center;color:white;margin-top:20px;font-size:0.9em;">
      Ãšltima atualizaÃ§Ã£o: <span id="last-update"></span> | SAP v1.0.1
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    let dadosAlertas = [];
    document.getElementById('last-update').innerText = new Date().toLocaleString();

    async function carregarAlertas() {
      const res = await fetch('/api/alerts');
      const json = await res.json();
      dadosAlertas = json.alertas || [];
      atualizarDashboard();
    }

    function contarPorPeriodo(p) {
      const agora = new Date();
      return dadosAlertas.filter(a => {
        const ts = new Date(a.timestamp);
        if(p==='24h') return agora - ts <= 24*60*60*1000;
        if(p==='7dias') return agora - ts <= 7*24*60*60*1000;
        if(p==='mes') return ts.getMonth() === agora.getMonth() && ts.getFullYear() === agora.getFullYear();
        if(p==='ano') return ts.getFullYear() === agora.getFullYear();
        return true;
      });
    }

    function atualizarDashboard() {
      const p = document.getElementById('periodo').value;
      document.getElementById('total-geral').innerText = dadosAlertas.length;
      document.getElementById('total-mes').innerText = contarPorPeriodo('mes').length;
      document.getElementById('total-ano').innerText = contarPorPeriodo('ano').length;
      document.getElementById('total-7dias').innerText = contarPorPeriodo('7dias').length;
      document.getElementById('total-24h').innerText = contarPorPeriodo('24h').length;

      const filtrados = contarPorPeriodo(p);
      const labels = filtrados.map(a => new Date(a.timestamp).toLocaleTimeString());
      const dataPts = filtrados.map(_ => 1);
      const ctx = document.getElementById('timelineChart').getContext('2d');
      if (window.timelineChart) window.timelineChart.destroy();
      window.timelineChart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [{ label: 'Alertas', data: dataPts, fill: false, borderColor: '#ffd700' }] },
        options: { scales: { x: { display: false } } }
      });
    }

    window.onload = carregarAlertas;
  </script>
</body>
</html>
